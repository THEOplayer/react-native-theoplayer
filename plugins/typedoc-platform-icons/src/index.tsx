import {
  Application,
  Context,
  Converter,
  PageEvent,
  ReflectionKind,
} from 'typedoc';

const style = String.raw`
<style>
.platform-tag {
  display: inline-flex;
  align-items: center;
  border-radius: 20px;
  padding: 4px;
  font-size: small;
  margin-left: 4px;
}

.platform-tag-ios {
  border: purple 2px solid;
  background-color: purple;
}

.platform-tag-android {
  border: green 2px solid;
  background-color: green;
}

.platform-tag-web {
  border: dodgerblue 2px solid;
  background-color: dodgerblue;
}

.margin-left-xs {
  margin-left: 4px;
}
</style>
`;

export function load(app: Application): void {
  app.renderer.on(PageEvent.END, (event: PageEvent) => {
    if (event.contents === undefined) {
      return;
    }
    const html = event.contents;
    const headEndIndex = html.indexOf('</head>');
    event.contents =  html.slice(0, headEndIndex) + style + html.slice(headEndIndex);
  });

  app.converter.on(Converter.EVENT_RESOLVE_BEGIN, (ctx: Context) => {
    for (const reflection of ctx.project.getReflectionsByKind(ReflectionKind.All)) {
      const { comment } = reflection;
      if (comment) {
        comment.getTags('@platform').forEach((part) => {
          const tags = part.content[0];
          if (!tags) {
            return;
          }
          part.content = [];
          if (tags.text.indexOf('ios') >= 0) {
            part.content.push({
              kind: 'text',
              text: `<div class="platform-tag platform-tag-ios">
                      <svg xmlns="http://www.w3.org/2000/svg" xml:space="preserve" width="14" height="14" viewBox="0 0 20 20"><path fill="white" d="M17.85 14.227c-.106.307-.217.6-.335.881a10.338 10.338 0 0 1-1.022 1.836c-.536.766-.976 1.296-1.315 1.59-.525.483-1.088.731-1.691.744-.433 0-.954-.123-1.562-.372-.609-.249-1.169-.372-1.681-.372-.537 0-1.113.123-1.729.372-.617.249-1.114.38-1.494.392-.578.025-1.154-.229-1.729-.764-.367-.32-.826-.869-1.376-1.646-.59-.83-1.075-1.793-1.455-2.891-.407-1.185-.611-2.333-.611-3.444 0-1.273.275-2.371.826-3.291a4.846 4.846 0 0 1 1.73-1.75 4.654 4.654 0 0 1 2.339-.66c.459 0 1.061.142 1.809.421.746.28 1.225.422 1.435.422.157 0 .689-.166 1.591-.497.853-.307 1.573-.434 2.163-.384 1.598.129 2.798.759 3.597 1.894-1.429.866-2.136 2.079-2.122 3.635.013 1.212.452 2.221 1.316 3.022.392.371.83.658 1.316.862zM13.83.305c.013.127.019.254.019.38 0 .95-.347 1.837-1.038 2.658-.835.976-1.845 1.54-2.94 1.451a2.95 2.95 0 0 1-.022-.36c0-.912.397-1.888 1.102-2.686.352-.404.8-.74 1.342-1.008.542-.264 1.055-.41 1.537-.435z"/></svg>
                      <span class="margin-left-xs">iOS</span>
                    </div>`
            });
          }
          if (tags.text.indexOf('android') >= 0) {
            part.content.push({
              kind: 'text',
              text: `<div class="platform-tag platform-tag-android">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 675 675"><path fill="white" d="M672.38 514.23c-.22-1.378-.43-2.74-.66-4.102a335.112 335.112 0 0 0-5.13-25.041 337.18 337.18 0 0 0-28.51-75.63 341.207 341.207 0 0 0-24.56-40.072 338.6 338.6 0 0 0-37.1-43.697 334.176 334.176 0 0 0-17.66-16.361 339.62 339.62 0 0 0-42.06-30.98c.13-.214.24-.443.37-.657 6.79-11.732 13.6-23.449 20.39-35.181l19.92-34.361a10427.4 10427.4 0 0 0 14.3-24.68 31.28 31.28 0 0 0 2.69-6.038 30.96 30.96 0 0 0 .45-17.444 31.743 31.743 0 0 0-3.35-7.959c-2.54-4.266-6.17-7.974-10.73-10.682a31.15 31.15 0 0 0-13.16-4.233 31.455 31.455 0 0 0-5.83.05c-1.6.163-3.19.459-4.77.869a30.865 30.865 0 0 0-14.9 9.041 31.106 31.106 0 0 0-3.91 5.333c-4.77 8.221-9.54 16.459-14.3 24.68l-19.92 34.361c-6.79 11.733-13.6 23.449-20.39 35.182-.74 1.279-1.49 2.559-2.23 3.856-1.03-.411-2.05-.821-3.08-1.215-37.44-14.276-78.06-22.087-120.52-22.087-1.16 0-2.31 0-3.48.017-37.75.377-74.02 6.941-107.86 18.723a314.032 314.032 0 0 0-11.62 4.316c-.69-1.198-1.4-2.396-2.08-3.594-6.79-11.733-13.6-23.449-20.39-35.182l-19.92-34.36c-4.78-8.222-9.55-16.46-14.3-24.68a31.643 31.643 0 0 0-3.91-5.333 30.865 30.865 0 0 0-14.9-9.042c-1.58-.41-3.17-.705-4.78-.87a31.34 31.34 0 0 0-5.82-.049 30.784 30.784 0 0 0-13.17 4.234 30.809 30.809 0 0 0-10.72 10.682 30.373 30.373 0 0 0-1.95 3.873 29.589 29.589 0 0 0-1.4 4.086 31.048 31.048 0 0 0 .44 17.443 31.905 31.905 0 0 0 2.69 6.039c4.78 8.22 9.55 16.458 14.3 24.68 6.65 11.453 13.29 22.907 19.93 34.36 6.79 11.733 13.59 23.449 20.38 35.182.05.098.12.197.17.295a339.667 339.667 0 0 0-39.03 28.273 337.741 337.741 0 0 0-21.27 19.445 341.007 341.007 0 0 0-37.1 43.698 335.863 335.863 0 0 0-24.56 40.072 337.18 337.18 0 0 0-28.51 75.63 343.767 343.767 0 0 0-5.13 25.041c-.23 1.362-.44 2.74-.65 4.102a328.42 328.42 0 0 0-1.94 14.818h673.11c-.54-4.972-1.18-9.912-1.93-14.818l.05-.033Z"/><path fill="#202124" d="M512.79 435.987c13.47-8.966 15.43-29.71 4.37-46.331-11.05-16.622-30.93-22.827-44.39-13.861-13.47 8.967-15.43 29.71-4.37 46.331 11.05 16.622 30.93 22.828 44.39 13.861ZM207.6 422.184c11.06-16.622 9.1-37.365-4.37-46.331-13.47-8.967-33.34-2.761-44.4 13.86-11.05 16.622-9.09 37.365 4.37 46.331 13.47 8.967 33.35 2.761 44.4-13.86Z"/></svg>
                      <span class="margin-left-xs">Android</span>
                    </div>`
            });
          }
          if (tags.text.indexOf('web') >= 0) {
            part.content.push({
              kind: 'text',
              text: `<div class="platform-tag platform-tag-web">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="white" d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95a15.65 15.65 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A7.987 7.987 0 0 1 5.08 16zm2.95-8H5.08a7.987 7.987 0 0 1 4.33-3.56A15.65 15.65 0 0 0 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg>
                      <span class="margin-left-xs">Web</span>
                    </div>`
            });
          }
        });
      }
    }
  });
}
